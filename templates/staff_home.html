<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Woxsen Staff</title>
    <link rel="stylesheet" href="/static/css/staff_home.css" />
  </head>
  <body>
    <div class="nav-bar">
      <div class="nav-heading">
        <a href="">Woxsen</a>
      </div>

      <div class="nav-items">
        <div class="nav-item">
          <a href="/logout">Logout</a>
        </div>
      </div>
    </div>
    <div id="staff_home">
      <div class="container" style="margin-top: 10px">
        <h1>Woxsen Student Transportation</h1>
        <table class="rwd-table">
          <tbody>
            <tr>
              <th>Travel Date</th>
              <th>Bus ID</th>
              <th>Bus No</th>
              <th>Update Bus No</th>
              <th>Total Seats</th>
              <th>Fare</th>
              <th>Total seats Booked</th>
              <th>CSV File</th>
              <th>Update Changes</th>
            </tr>
            {% for bus_number,value in data.items() %} {% for travel_date, seats
            in value.items()%}
            <script>
              // Calculate the current date on the client side
              var currentDate = new Date();
              var day = currentDate.getDate();
              var month = currentDate.getMonth() + 1; // Months are zero-based
              var year = currentDate.getFullYear();
              
              // Format it as YYYY-MM-DD (assuming you want this format)
              var today_date = year + '-' + (month < 10 ? '0' : '') + month + '-' + (day < 10 ? '0' : '') + day;
              
              // Compare it with the travel_date and set the not_today variable
              var travelDate = '{{ travel_date }}';
              
              // Conditionally disable the input field
              if (travelDate === today_date) {
    // If travel_date is today's date, display the <tr> element
                document.write('<tr>');
                document.write('<td data-th="Supplier Code">{{travel_date}}</td>');
                document.write('<td>{{seats[2]}}</td>');
                document.write('<td>{{bus_number}}</td>');
                document.write('<td data-th="Supplier Name">');
                document.write('<input type="text" name="bus_number" id="bn" placeholder="Bus Number" class="busN" />');
                document.write('</td>');
                document.write('<td data-th="Invoice Number">');
                document.write('<input type="number" class="seats-input" value="{{seats[1]}}" data-date="{{travel_date}}" data-seats="{{seats[1]}}" />');
                document.write('</td>');
                document.write('<td data-th="Invoice Number">');
                document.write('<input type="number" class="fare-input" value="{{seats[-1]}}" data-fare="{{seats[-1]}}" data-bus="{{bus_number}}" />');
                document.write('</td>');
                document.write('<td data-th="Invoice Number">{{seats[0]}}</td>');
                document.write('<td data-th="Invoice Number">');
                document.write('<a href="/csv?date={{travel_date}}&bus_number={{bus_number}}" download>Download</a>');
                document.write('</td>');
                document.write('<td>');
                document.write('<button data-date="{{travel_date}}" data-bus="{{bus_number}}" class="disabled">save</button>');
                document.write('</td>');
                document.write('</tr>');
              }
              // console.log(inputField)
            </script>
            <!-- <tr>
              <td data-th="Supplier Code">{{travel_date}}</td>
              <td>{{seats[2]}}</td>
              <td>{{bus_number}}</td>
              <td data-th="Supplier Name">
                <input 
                type="text" 
                name="bus_number" 
                id="bn" 
                placeholder="Bus Number"
                class="busN"
                disabled= false
                />
              </td>
              <td data-th="Invoice Number">
                <input
                  type="number"
                  class="seats-input"
                  value="{{seats[1]}}"
                  data-date="{{travel_date}}"
                  data-seats="{{seats[1]}}"
                />
              </td>
              <td data-th="Invoice Number">
                <input
                  type="number"
                  class="fare-input"
                  value="{{seats[-1]}}"
                  data-fare="{{seats[-1]}}"
                  data-bus="{{bus_number}}"
                />
              </td>
              <td data-th="Invoice Number">{{seats[0]}}</td>
              <td data-th="Invoice Number">
                <a
                  href="/csv?date={{travel_date}}&bus_number={{bus_number}}"
                  download
                >
                  Download
                </a>
              </td>
              <td>
                <button data-date="{{travel_date}}" data-bus="{{bus_number}}" class="disabled">
                  save
                </button>
              </td>
            </tr> -->
            {% endfor %} {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    <script defer>

      // get all the input fields class name seats-input and type number
      const inputs = document.querySelectorAll(".seats-input");
      const buttons = document.querySelectorAll("button");

      const fareInputs = document.querySelectorAll(".fare-input");

      // Update bus number event

      // const bno = document.getElementById("bn")
      // bno.addEventListener("input", (e) => {
      //   const bnum = e.target.value
      //   console.log(`bnum : ${bnum}`)
      //   console.log(`data-bus : ${e.target.getAttribute("data-bus")}`)
      //   const button = document.querySelector(`button[data-date="${date}"]`);
      //   if(bnum === e.target.getAttribute("data-bus")) {
      //       if (button.classList.contains("disabled")) return
      //       button.classList.add("disabled");
      //       return;
      //     } else {
      //       if (!button.classList.contains("disabled")) return
      //       button.classList.remove("disabled");
      //     }
      // })

      // add event listener to each input field
      inputs.forEach((input) => {
        input.addEventListener("input", (e) => {
          // data attribute
          // custom functionality
          const busNumber = document.getElementById("bn").value
          const date = e.target.getAttribute("data-date");
          const seats = e.target.getAttribute("data-seats");


          // get the button with the same date attribute
          const button = document.querySelector(`button[data-date="${date}"]`);

          if (seats === e.target.value) {
            // add disabled class 
            if (button.classList.contains("disabled")) return
            button.classList.add("disabled");
            return;
          } else {
            // remove disabled class
            console.log(`Bus Number : ${busNumber} \n Date : ${date} \n Seats : ${seats}`)
            if (!button.classList.contains("disabled")) return
            button.classList.remove("disabled");
          }
        });
      });


      fareInputs.forEach((e) => {
        e.addEventListener("input", (e) => {
          // data attribute
          const bus_number = e.target.getAttribute("data-bus");
          const fare = e.target.getAttribute("data-fare");

          // get the button with the same date attribute
          const button = document.querySelector(`button[data-bus="${bus_number}"]`);

          if (fare === e.target.value) {
            // add disabled class
            if (button.classList.contains("disabled")) return
            button.classList.add("disabled");
            return;
          } else {
            // remove disabled class
            if (!button.classList.contains("disabled")) return
            button.classList.remove("disabled");
          }
        });
      })

      buttons.forEach((button) => {
        button.addEventListener("click", (e) => {
          // if button has disabled class return
          if (button.classList.contains("disabled")) return;

          // data attribute
          const date = e.target.getAttribute("data-date");

          // get the button with the same date attribute
          const input = document.querySelector(`input[data-date="${date}"]`);
          
          
          // get the fare input
          fareInput = document.querySelector(`input[data-bus="${button.getAttribute("data-bus")}"]`)
          
          const bus_number = fareInput.getAttribute("data-bus");

          // if input value is greater than 40 return
          if (input.value > 40) {
            alert("Seats cannot be greater than 40");
            input.value = input.getAttribute("data-seats");
            return;
          }

          // if input value is less than 0 return
          if (input.value < 0) {
            alert("Seats cannot be less than 0");
            return;
          }

          fetch(`/update-bus-info?date=${date}&bus_number=${bus_number}&seats=${input.value}&fare=${fareInput.value}&updated_bus_number=${document.getElementById("bn").value}`)
            .then((res) => res.json())
            .then((data) => {
              if (data.status === "success") {
                alert("Data updated successfully");
                input.setAttribute("data-seats", input.value);
                button.classList.add("disabled");
              } else {
                alert("Something went wrong");
              }
            });
        });
      });
    </script>
  </body>
</html>
